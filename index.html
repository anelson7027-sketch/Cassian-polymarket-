<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
            --border: #30363d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 12px;
            font-size: 14px;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: var(--accent-blue);
        }
        .header p { color: var(--text-secondary); font-size: 0.8rem; }
        .status-bar {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-bar .status { color: var(--accent-yellow); }
        .status-bar .status.success { color: var(--accent-green); }
        .status-bar .status.error { color: var(--accent-red); }
        button {
            background: var(--accent-blue);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }
        button:disabled { opacity: 0.5; }
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .market-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .market-question {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .market-question a { color: var(--text-primary); text-decoration: none; }
        .market-question a:hover { color: var(--accent-blue); }
        .prices-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .price-box {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .price-box.yes {
            background: rgba(63, 185, 80, 0.15);
            border: 1px solid rgba(63, 185, 80, 0.3);
        }
        .price-box.no {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid rgba(248, 81, 73, 0.3);
        }
        .price-box .price {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .price-box.yes .price { color: var(--accent-green); }
        .price-box.no .price { color: var(--accent-red); }
        .price-box .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .price-box .payout {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .price-box .payout strong {
            color: var(--text-primary);
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-item {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-item .val {
            font-weight: bold;
            font-size: 0.95rem;
        }
        .stat-item .lbl {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .analysis-box {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        .analysis-box h4 {
            color: var(--accent-blue);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .analysis-box p {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }
        .analysis-box .highlight {
            color: var(--text-primary);
            font-weight: 500;
        }
        .tags {
            margin-top: 10px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .tag-momentum { background: rgba(88,166,255,0.2); color: var(--accent-blue); }
        .tag-volume { background: rgba(210,153,34,0.2); color: var(--accent-yellow); }
        .tag-extreme { background: rgba(163,113,247,0.2); color: var(--accent-purple); }
        .tag-liquid { background: rgba(63,185,80,0.2); color: var(--accent-green); }
        .empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .debug {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¯ Polymarket Scanner</h1>
        <p>Find profitable prediction market opportunities</p>
    </div>

    <div class="status-bar">
        <span class="status" id="status">Initializing...</span>
        <button onclick="loadData()" id="refresh-btn">ðŸ”„ Refresh</button>
    </div>

    <div class="debug" id="debug">Debug log...</div>

    <div class="filters">
        <select id="min-liquidity">
            <option value="0">All Markets</option>
            <option value="5000">$5K+ Liquidity</option>
            <option value="20000">$20K+ Liquidity</option>
        </select>
        <select id="sort-by">
            <option value="score">Best Opportunities</option>
            <option value="volume">Highest Volume</option>
            <option value="liquidity">Most Liquid</option>
        </select>
    </div>

    <div id="markets-container">
        <div class="loading">Loading markets...</div>
    </div>

    <script>
        let allMarkets = [];
        let debugLog = [];
        
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugLog.push(`[${time}] ${msg}`);
            if (debugLog.length > 20) debugLog.shift();
            document.getElementById('debug').textContent = debugLog.join('\n');
            console.log(msg);
        }

        function setStatus(msg, type = '') {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = 'status ' + type;
        }

        async function loadData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            setStatus('Fetching markets...', '');
            log('Starting data fetch...');

            try {
                // Try multiple CORS proxies
                const proxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                const apiUrl = 'https://gamma-api.polymarket.com/markets?closed=false&limit=50';
                let data = null;
                
                for (const proxy of proxies) {
                    try {
                        log(`Trying proxy: ${proxy.substring(0, 30)}...`);
                        const url = proxy + encodeURIComponent(apiUrl);
                        const response = await fetch(url, { timeout: 15000 });
                        
                        if (response.ok) {
                            const text = await response.text();
                            log(`Got response: ${text.length} bytes`);
                            data = JSON.parse(text);
                            log(`Parsed ${data.length} markets`);
                            break;
                        }
                    } catch (e) {
                        log(`Proxy failed: ${e.message}`);
                    }
                }
                
                if (!data) {
                    throw new Error('All proxies failed');
                }

                allMarkets = data.filter(m => m.active && !m.closed).map(m => {
                    let prices = m.outcomePrices || ['0.5', '0.5'];
                    if (typeof prices === 'string') {
                        try { prices = JSON.parse(prices); } catch(e) { prices = ['0.5', '0.5']; }
                    }
                    
                    const yesPrice = parseFloat(prices[0] || 0.5);
                    const noPrice = parseFloat(prices[1] || 0.5);
                    const volume24h = parseFloat(m.volume24hr || 0);
                    const liquidity = parseFloat(m.liquidityNum || m.liquidity || 0);
                    
                    // Calculate score
                    let score = 0;
                    let signals = [];
                    
                    if (volume24h > 5000) { score += 15; signals.push('volume'); }
                    if (volume24h > 50000) score += 20;
                    if (liquidity > 10000) { score += 10; signals.push('liquid'); }
                    if (liquidity > 0 && volume24h / liquidity > 0.25) { score += 20; signals.push('momentum'); }
                    if (yesPrice < 0.15 || yesPrice > 0.85) { score += 15; signals.push('extreme'); }
                    
                    return {
                        question: m.question || m.title || 'Unknown',
                        slug: m.slug || m.conditionId,
                        yesPrice,
                        noPrice,
                        volume24h,
                        liquidity,
                        score,
                        signals,
                        endDate: m.endDate
                    };
                });

                log(`Processed ${allMarkets.length} active markets`);
                setStatus(`âœ“ Loaded ${allMarkets.length} markets`, 'success');
                renderMarkets();

            } catch (error) {
                log(`Error: ${error.message}`);
                setStatus('Failed: ' + error.message, 'error');
                document.getElementById('markets-container').innerHTML = 
                    '<div class="empty">Failed to load data. Tap refresh to retry.</div>';
            } finally {
                btn.disabled = false;
            }
        }

        function renderMarkets() {
            const minLiq = parseInt(document.getElementById('min-liquidity').value);
            const sortBy = document.getElementById('sort-by').value;
            
            let markets = allMarkets.filter(m => m.liquidity >= minLiq);
            
            markets.sort((a, b) => {
                if (sortBy === 'volume') return b.volume24h - a.volume24h;
                if (sortBy === 'liquidity') return b.liquidity - a.liquidity;
                return b.score - a.score;
            });

            log(`Rendering ${markets.length} markets after filter`);

            if (markets.length === 0) {
                document.getElementById('markets-container').innerHTML = 
                    '<div class="empty">No markets found. Try changing filters.</div>';
                return;
            }

            const html = markets.slice(0, 25).map(m => {
                const yesPayout = (1 / m.yesPrice).toFixed(2);
                const noPayout = (1 / m.noPrice).toFixed(2);
                const yesROI = ((1 / m.yesPrice - 1) * 100).toFixed(0);
                const noROI = ((1 / m.noPrice - 1) * 100).toFixed(0);
                
                let analysis = '';
                if (m.yesPrice < 0.1) {
                    analysis = `<span class="highlight">Long-shot bet:</span> YES is priced at just ${(m.yesPrice*100).toFixed(0)}Â¢. If you bet $10 and YES wins, you'd get <span class="highlight">$${(10/m.yesPrice).toFixed(0)}</span> back (${yesROI}% return). High risk, high reward.`;
                } else if (m.yesPrice > 0.9) {
                    analysis = `<span class="highlight">Near-certainty:</span> Market prices YES at ${(m.yesPrice*100).toFixed(0)}%. The value might be in betting NO at ${(m.noPrice*100).toFixed(0)}Â¢ â€” a $10 NO bet pays <span class="highlight">$${(10/m.noPrice).toFixed(0)}</span> if it hits.`;
                } else if (m.signals.includes('momentum')) {
                    const ratio = (m.volume24h / m.liquidity * 100).toFixed(0);
                    analysis = `<span class="highlight">Hot market:</span> ${ratio}% volume-to-liquidity ratio suggests heavy trading activity. Smart money may be moving. Current YES odds imply ${(m.yesPrice*100).toFixed(0)}% probability.`;
                } else if (m.volume24h > 50000) {
                    analysis = `<span class="highlight">High volume:</span> $${(m.volume24h/1000).toFixed(0)}K traded in 24h. Market prices YES at ${(m.yesPrice*100).toFixed(0)}% probability. Good liquidity for entering/exiting positions.`;
                } else {
                    analysis = `Market implies ${(m.yesPrice*100).toFixed(0)}% chance of YES. A $10 YES bet returns <span class="highlight">$${(10/m.yesPrice).toFixed(0)}</span> if correct. A $10 NO bet returns <span class="highlight">$${(10/m.noPrice).toFixed(0)}</span> if correct.`;
                }

                return `
                    <div class="market-card">
                        <div class="market-question">
                            <a href="https://polymarket.com/event/${m.slug}" target="_blank">${m.question}</a>
                        </div>
                        
                        <div class="prices-row">
                            <div class="price-box yes">
                                <div class="label">BUY YES</div>
                                <div class="price">${(m.yesPrice*100).toFixed(0)}Â¢</div>
                                <div class="payout">Win â†’ <strong>${yesPayout}x</strong> (+${yesROI}%)</div>
                            </div>
                            <div class="price-box no">
                                <div class="label">BUY NO</div>
                                <div class="price">${(m.noPrice*100).toFixed(0)}Â¢</div>
                                <div class="payout">Win â†’ <strong>${noPayout}x</strong> (+${noROI}%)</div>
                            </div>
                        </div>
                        
                        <div class="stats-row">
                            <div class="stat-item">
                                <div class="val">$${formatNum(m.liquidity)}</div>
                                <div class="lbl">Liquidity</div>
                            </div>
                            <div class="stat-item">
                                <div class="val">$${formatNum(m.volume24h)}</div>
                                <div class="lbl">24h Volume</div>
                            </div>
                            <div class="stat-item">
                                <div class="val">${m.score}</div>
                                <div class="lbl">Score</div>
                            </div>
                        </div>
                        
                        <div class="analysis-box">
                            <h4>ðŸ’¡ Analysis</h4>
                            <p>${analysis}</p>
                            <div class="tags">
                                ${m.signals.map(s => `<span class="tag tag-${s}">${s.toUpperCase()}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('markets-container').innerHTML = html;
        }

        function formatNum(n) {
            if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n/1e3).toFixed(0) + 'K';
            return n.toFixed(0);
        }

        document.getElementById('min-liquidity').addEventListener('change', renderMarkets);
        document.getElementById('sort-by').addEventListener('change', renderMarkets);

        // Load on start
        loadData();
    </script>
</body>
</html>
