<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Opportunity Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
            --border: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.blue .value { color: var(--accent-blue); }
        .stat-card.yellow .value { color: var(--accent-yellow); }
        .stat-card.purple .value { color: var(--accent-purple); }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        select, input, button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        button {
            cursor: pointer;
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            font-weight: 600;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-content {
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .opportunity-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        .opportunity-card:hover {
            border-color: var(--accent-blue);
        }

        .opportunity-card:last-child {
            margin-bottom: 0;
        }

        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 10px;
        }

        .opportunity-title {
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            line-height: 1.3;
        }

        .opportunity-score {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
        }

        .score-high {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }

        .score-medium {
            background: rgba(210, 153, 34, 0.2);
            color: var(--accent-yellow);
        }

        .score-low {
            background: rgba(139, 148, 158, 0.2);
            color: var(--text-secondary);
        }

        .opportunity-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .detail-item {
            text-align: center;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .detail-value {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .detail-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .opportunity-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 4px;
        }

        .tag-arbitrage {
            background: rgba(163, 113, 247, 0.2);
            color: var(--accent-purple);
        }

        .tag-value {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }

        .tag-momentum {
            background: rgba(88, 166, 255, 0.2);
            color: var(--accent-blue);
        }

        .recommendation {
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--accent-blue);
            padding: 8px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 6px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-secondary);
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .refresh-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .method-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .method-item h4 {
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .method-item p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .header h1 { font-size: 1.4rem; }
            .opportunity-details { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            .detail-value { font-size: 0.85rem; }
            .controls { flex-direction: column; align-items: stretch; }
            .control-group { justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Polymarket Scanner</h1>
        <p>Identifying profitable prediction market opportunities</p>
    </div>

    <div class="stats-grid" id="stats-grid">
        <div class="stat-card blue">
            <div class="value" id="total-markets">-</div>
            <div class="label">Markets</div>
        </div>
        <div class="stat-card green">
            <div class="value" id="opportunities-found">-</div>
            <div class="label">Opportunities</div>
        </div>
        <div class="stat-card yellow">
            <div class="value" id="avg-edge">-</div>
            <div class="label">Avg Edge</div>
        </div>
        <div class="stat-card purple">
            <div class="value" id="total-volume">-</div>
            <div class="label">24h Volume</div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Min Liquidity:</label>
            <select id="min-liquidity">
                <option value="1000">$1K+</option>
                <option value="10000" selected>$10K+</option>
                <option value="50000">$50K+</option>
                <option value="100000">$100K+</option>
            </select>
        </div>
        <div class="control-group">
            <label>Strategy:</label>
            <select id="strategy-filter">
                <option value="all">All</option>
                <option value="value">Value</option>
                <option value="arbitrage">Arbitrage</option>
                <option value="momentum">Momentum</option>
            </select>
        </div>
        <button id="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
        <span class="refresh-time" id="last-refresh"></span>
    </div>

    <div class="method-grid">
        <div class="method-item">
            <h4><span class="tag tag-value">VALUE</span> Expected Value</h4>
            <p>Markets where prices may not reflect true probability</p>
        </div>
        <div class="method-item">
            <h4><span class="tag tag-arbitrage">ARB</span> Arbitrage</h4>
            <p>YES + NO prices don't sum to 100%</p>
        </div>
        <div class="method-item">
            <h4><span class="tag tag-momentum">MOM</span> Momentum</h4>
            <p>High volume indicating smart money movement</p>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>üî• Top Opportunities</h2>
            <span id="opp-count">0 found</span>
        </div>
        <div class="panel-content" id="opportunities-list">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading markets...</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>üìà Category Distribution</h2>
        </div>
        <div class="panel-content">
            <div class="chart-container">
                <canvas id="volume-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // CORS Proxy - using allorigins which is reliable
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const GAMMA_API = 'https://gamma-api.polymarket.com';
        
        let allMarkets = [];
        let opportunities = [];
        let volumeChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Auto-refresh every 5 minutes
            setInterval(loadData, 300000);
        });

        async function loadData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';

            try {
                await fetchMarkets();
                analyzeOpportunities();
                renderOpportunities();
                updateStats();
                updateCharts();
                
                document.getElementById('last-refresh').textContent = 
                    `Updated: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('opportunities-list').innerHTML = 
                    `<div class="error">
                        <strong>Failed to load data</strong><br><br>
                        ${error.message}<br><br>
                        <small>Try refreshing in a moment. Polymarket API may be rate-limited.</small>
                    </div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Refresh';
            }
        }

        async function fetchMarkets() {
            const url = `${GAMMA_API}/markets?closed=false&limit=100`;
            const response = await fetch(CORS_PROXY + encodeURIComponent(url));
            
            if (!response.ok) {
                throw new Error(`API returned ${response.status}`);
            }
            
            const data = await response.json();
            
            allMarkets = data
                .filter(m => m.active && !m.closed)
                .map(market => {
                    const outcomePrices = market.outcomePrices ? 
                        (typeof market.outcomePrices === 'string' ? 
                            JSON.parse(market.outcomePrices) : market.outcomePrices) : [0.5, 0.5];
                    
                    return {
                        ...market,
                        yesPrice: parseFloat(outcomePrices[0] || 0.5),
                        noPrice: parseFloat(outcomePrices[1] || 0.5),
                        volume24h: parseFloat(market.volume24hr || 0),
                        totalVolume: parseFloat(market.volume || 0),
                        liquidity: parseFloat(market.liquidityNum || market.liquidity || 0),
                        spread: calculateSpread(market),
                        category: categorizeMarket(market),
                        endDate: market.endDate ? new Date(market.endDate) : null
                    };
                });
        }

        function calculateSpread(market) {
            const bid = parseFloat(market.bestBid || 0);
            const ask = parseFloat(market.bestAsk || 0);
            if (bid && ask && ask > bid) {
                return ((ask - bid) / ask * 100);
            }
            return 5;
        }

        function categorizeMarket(market) {
            const title = (market.question || market.title || '').toLowerCase();
            const tags = (market.tags || []).map(t => t.toLowerCase());
            
            if (tags.includes('politics') || title.includes('trump') || title.includes('biden') || 
                title.includes('election') || title.includes('president') || title.includes('congress')) {
                return 'politics';
            }
            if (tags.includes('crypto') || title.includes('bitcoin') || title.includes('ethereum') || 
                title.includes('btc') || title.includes('eth') || title.includes('crypto')) {
                return 'crypto';
            }
            if (tags.includes('sports') || title.includes('nfl') || title.includes('nba') || 
                title.includes('super bowl') || title.includes('championship')) {
                return 'sports';
            }
            return 'other';
        }

        function analyzeOpportunities() {
            const minLiquidity = parseInt(document.getElementById('min-liquidity').value);
            
            opportunities = allMarkets
                .filter(m => m.liquidity >= minLiquidity)
                .map(market => {
                    const analysis = analyzeMarket(market);
                    return { ...market, ...analysis };
                })
                .filter(m => m.score > 0)
                .sort((a, b) => b.score - a.score);
        }

        function analyzeMarket(market) {
            let score = 0;
            let signals = [];
            let expectedEdge = 0;
            
            // 1. Arbitrage Detection
            const priceSum = market.yesPrice + market.noPrice;
            if (priceSum < 0.97 || priceSum > 1.03) {
                const arbEdge = Math.abs(1 - priceSum) * 100;
                score += arbEdge * 10;
                signals.push('arbitrage');
                expectedEdge += arbEdge;
            }
            
            // 2. Value Bet Detection
            if (market.spread > 3 && market.volume24h > 10000) {
                score += (market.spread / 2) * 5;
                signals.push('value');
                expectedEdge += market.spread / 4;
            }
            
            // 3. Momentum Detection
            const volumeToLiquidity = market.volume24h / (market.liquidity || 1);
            if (volumeToLiquidity > 0.5) {
                score += volumeToLiquidity * 20;
                signals.push('momentum');
            }
            
            // 4. Mispricing at extremes
            if ((market.yesPrice < 0.1 || market.yesPrice > 0.9) && market.volume24h > 50000) {
                const extremity = Math.min(market.yesPrice, 1 - market.yesPrice);
                score += (0.1 - extremity) * 100;
                signals.push('value');
                expectedEdge += (0.1 - extremity) * 50;
            }
            
            // 5. Time value for soon-expiring
            if (market.endDate) {
                const daysToExpiry = (market.endDate - new Date()) / (1000 * 60 * 60 * 24);
                if (daysToExpiry > 0 && daysToExpiry < 7) {
                    score += (7 - daysToExpiry) * 3;
                }
            }
            
            // Penalize low liquidity
            if (market.liquidity < 50000) {
                score *= 0.5;
            }
            
            return {
                score: Math.round(score),
                signals: [...new Set(signals)],
                expectedEdge: expectedEdge.toFixed(2),
                recommendation: getRecommendation(market, signals)
            };
        }

        function getRecommendation(market, signals) {
            if (signals.includes('arbitrage')) {
                const spread = ((1 - (market.yesPrice + market.noPrice)) * 100).toFixed(1);
                return `Potential ${spread}% arbitrage opportunity`;
            }
            if (market.yesPrice < 0.15) {
                return `Low-prob YES at ${(market.yesPrice * 100).toFixed(0)}¬¢ - high asymmetric upside if it hits`;
            }
            if (market.yesPrice > 0.85) {
                return `High-prob at ${(market.yesPrice * 100).toFixed(0)}¬¢ - consider NO position for value`;
            }
            if (signals.includes('momentum')) {
                return `Unusual volume activity - potential informed trading`;
            }
            return `Estimated edge: ~${market.expectedEdge}%`;
        }

        function renderOpportunities() {
            const container = document.getElementById('opportunities-list');
            const strategyFilter = document.getElementById('strategy-filter').value;
            
            let filtered = opportunities;
            
            if (strategyFilter !== 'all') {
                filtered = filtered.filter(o => o.signals.includes(strategyFilter));
            }
            
            document.getElementById('opp-count').textContent = `${filtered.length} found`;
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No opportunities match current filters.<br>Try lowering minimum liquidity.</div>';
                return;
            }
            
            container.innerHTML = filtered.slice(0, 25).map(opp => `
                <div class="opportunity-card">
                    <div class="opportunity-header">
                        <div class="opportunity-title">
                            <a href="https://polymarket.com/event/${opp.slug || opp.conditionId}" target="_blank" rel="noopener">
                                ${opp.question || opp.title}
                            </a>
                        </div>
                        <span class="opportunity-score ${getScoreClass(opp.score)}">
                            ${opp.score}
                        </span>
                    </div>
                    <div class="opportunity-details">
                        <div class="detail-item">
                            <div class="detail-value" style="color: var(--accent-green)">${(opp.yesPrice * 100).toFixed(0)}¬¢</div>
                            <div class="detail-label">YES</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value" style="color: var(--accent-red)">${(opp.noPrice * 100).toFixed(0)}¬¢</div>
                            <div class="detail-label">NO</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${formatCurrency(opp.liquidity)}</div>
                            <div class="detail-label">Liquidity</div>
                        </div>
                    </div>
                    <div class="opportunity-meta">
                        <div>
                            ${opp.signals.map(s => `<span class="tag tag-${s}">${s.toUpperCase()}</span>`).join('')}
                        </div>
                        <div>24h: ${formatCurrency(opp.volume24h)}</div>
                    </div>
                    <div class="recommendation">üí° ${opp.recommendation}</div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('total-markets').textContent = allMarkets.length;
            document.getElementById('opportunities-found').textContent = opportunities.length;
            
            const avgEdge = opportunities.length > 0 
                ? (opportunities.reduce((sum, o) => sum + parseFloat(o.expectedEdge), 0) / opportunities.length).toFixed(1)
                : '0';
            document.getElementById('avg-edge').textContent = avgEdge + '%';
            
            const totalVol = allMarkets.reduce((sum, m) => sum + m.volume24h, 0);
            document.getElementById('total-volume').textContent = formatCurrency(totalVol);
        }

        function updateCharts() {
            const categories = ['politics', 'crypto', 'sports', 'other'];
            const volumeByCategory = categories.map(cat => 
                allMarkets.filter(m => m.category === cat).reduce((sum, m) => sum + m.volume24h, 0)
            );
            
            if (volumeChart) volumeChart.destroy();
            
            volumeChart = new Chart(document.getElementById('volume-chart'), {
                type: 'doughnut',
                data: {
                    labels: ['Politics', 'Crypto', 'Sports', 'Other'],
                    datasets: [{
                        data: volumeByCategory,
                        backgroundColor: [
                            'rgba(88, 166, 255, 0.8)',
                            'rgba(163, 113, 247, 0.8)',
                            'rgba(63, 185, 80, 0.8)',
                            'rgba(139, 148, 158, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { 
                                color: '#f0f6fc',
                                font: { size: 11 },
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        function getScoreClass(score) {
            if (score >= 50) return 'score-high';
            if (score >= 20) return 'score-medium';
            return 'score-low';
        }

        function formatCurrency(num) {
            if (num >= 1000000) return '$' + (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return '$' + (num / 1000).toFixed(0) + 'K';
            return '$' + Math.round(num);
        }

        // Filter handlers
        document.getElementById('min-liquidity').addEventListener('change', () => {
            analyzeOpportunities();
            renderOpportunities();
            updateStats();
        });
        
        document.getElementById('strategy-filter').addEventListener('change', renderOpportunities);
    </script>
</body>
</html>
