<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Opportunity Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
            --border: #30363d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 15px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p { color: var(--text-secondary); font-size: 0.85rem; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
        }
        .stat-card .value { font-size: 1.3rem; font-weight: bold; margin-bottom: 3px; }
        .stat-card .label { color: var(--text-secondary); font-size: 0.65rem; text-transform: uppercase; }
        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.blue .value { color: var(--accent-blue); }
        .stat-card.yellow .value { color: var(--accent-yellow); }
        .stat-card.purple .value { color: var(--accent-purple); }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        select, button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        button {
            cursor: pointer;
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            font-weight: 600;
        }
        button:disabled { opacity: 0.5; }
        .refresh-time { font-size: 0.75rem; color: var(--text-secondary); margin-left: auto; }
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .panel-header {
            background: var(--bg-tertiary);
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 { font-size: 1rem; }
        .panel-content { padding: 12px; max-height: 65vh; overflow-y: auto; }
        .opp-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .opp-card:last-child { margin-bottom: 0; }
        .opp-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }
        .opp-title { font-weight: 600; font-size: 0.9rem; flex: 1; line-height: 1.3; }
        .opp-score {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
        }
        .score-high { background: rgba(63,185,80,0.2); color: var(--accent-green); }
        .score-medium { background: rgba(210,153,34,0.2); color: var(--accent-yellow); }
        .score-low { background: rgba(139,148,158,0.2); color: var(--text-secondary); }
        .opp-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }
        .detail-item {
            text-align: center;
            padding: 6px 4px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }
        .detail-value { font-weight: bold; font-size: 0.9rem; }
        .detail-label { font-size: 0.6rem; color: var(--text-secondary); text-transform: uppercase; }
        .opp-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin-right: 3px;
        }
        .tag-value { background: rgba(63,185,80,0.2); color: var(--accent-green); }
        .tag-momentum { background: rgba(88,166,255,0.2); color: var(--accent-blue); }
        .tag-volume { background: rgba(210,153,34,0.2); color: var(--accent-yellow); }
        .tag-extreme { background: rgba(163,113,247,0.2); color: var(--accent-purple); }
        .recommendation {
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--accent-blue);
            padding: 8px;
            background: rgba(88,166,255,0.1);
            border-radius: 6px;
        }
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 150px;
            color: var(--text-secondary);
            gap: 12px;
        }
        .spinner {
            width: 35px; height: 35px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error {
            background: rgba(248,81,73,0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .empty-state { text-align: center; padding: 30px; color: var(--text-secondary); }
        a { color: var(--accent-blue); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .chart-container { height: 220px; }
        @media (max-width: 500px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .opp-details { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Polymarket Scanner</h1>
        <p>Live prediction market opportunities</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="value" id="total-markets">-</div>
            <div class="label">Markets</div>
        </div>
        <div class="stat-card green">
            <div class="value" id="opportunities-found">-</div>
            <div class="label">Opps</div>
        </div>
        <div class="stat-card yellow">
            <div class="value" id="best-score">-</div>
            <div class="label">Top Score</div>
        </div>
        <div class="stat-card purple">
            <div class="value" id="total-volume">-</div>
            <div class="label">24h Vol</div>
        </div>
    </div>

    <div class="controls">
        <select id="min-liquidity">
            <option value="0">All Liquidity</option>
            <option value="5000" selected>$5K+ Liq</option>
            <option value="25000">$25K+ Liq</option>
        </select>
        <select id="sort-by">
            <option value="score">Sort: Score</option>
            <option value="volume">Sort: Volume</option>
            <option value="liquidity">Sort: Liquidity</option>
        </select>
        <button id="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
        <span class="refresh-time" id="last-refresh"></span>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>üî• Opportunities</h2>
            <span id="opp-count">Loading...</span>
        </div>
        <div class="panel-content" id="opportunities-list">
            <div class="loading">
                <div class="spinner"></div>
                <span>Scanning markets...</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header"><h2>üìä Volume by Category</h2></div>
        <div class="panel-content">
            <div class="chart-container"><canvas id="volume-chart"></canvas></div>
        </div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';
        const GAMMA_API = 'https://gamma-api.polymarket.com';
        
        let allMarkets = [];
        let opportunities = [];
        let volumeChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(loadData, 300000);
        });

        async function loadData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥';

            try {
                await fetchMarkets();
                analyzeOpportunities();
                renderOpportunities();
                updateStats();
                updateChart();
                document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('opportunities-list').innerHTML = 
                    '<div class="error">Failed to load. Tap refresh to retry.<br><small>' + error.message + '</small></div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ Refresh';
            }
        }

        async function fetchMarkets() {
            const url = GAMMA_API + '/markets?closed=false&limit=75';
            const response = await fetch(CORS_PROXY + encodeURIComponent(url));
            if (!response.ok) throw new Error('API error ' + response.status);
            
            const data = await response.json();
            allMarkets = data.filter(m => m.active && !m.closed).map(m => {
                let prices = m.outcomePrices || ['0.5','0.5'];
                if (typeof prices === 'string') prices = JSON.parse(prices);
                
                return {
                    ...m,
                    yesPrice: parseFloat(prices[0] || 0.5),
                    noPrice: parseFloat(prices[1] || 0.5),
                    volume24h: parseFloat(m.volume24hr || 0),
                    liquidity: parseFloat(m.liquidityNum || m.liquidity || 0),
                    category: categorize(m)
                };
            });
        }

        function categorize(m) {
            const t = (m.question || '').toLowerCase();
            if (t.includes('trump') || t.includes('biden') || t.includes('election') || t.includes('president')) return 'politics';
            if (t.includes('bitcoin') || t.includes('crypto') || t.includes('eth')) return 'crypto';
            if (t.includes('nfl') || t.includes('nba') || t.includes('sports')) return 'sports';
            return 'other';
        }

        function analyzeOpportunities() {
            const minLiq = parseInt(document.getElementById('min-liquidity').value);
            
            opportunities = allMarkets.filter(m => m.liquidity >= minLiq).map(m => {
                let score = 0;
                let signals = [];
                
                // Volume signal
                if (m.volume24h > 5000) {
                    score += 10;
                    signals.push('volume');
                }
                if (m.volume24h > 50000) score += 15;
                
                // Liquidity signal  
                if (m.liquidity > 20000) {
                    score += 8;
                    signals.push('value');
                }
                
                // Momentum: volume relative to liquidity
                if (m.liquidity > 0) {
                    const ratio = m.volume24h / m.liquidity;
                    if (ratio > 0.2) {
                        score += Math.min(ratio * 25, 30);
                        signals.push('momentum');
                    }
                }
                
                // Extreme odds (potential value)
                if (m.yesPrice < 0.15 || m.yesPrice > 0.85) {
                    score += 12;
                    signals.push('extreme');
                }
                
                return {
                    ...m,
                    score: Math.round(score),
                    signals,
                    recommendation: getRec(m, signals)
                };
            }).filter(m => m.score > 0);
            
            // Sort
            const sortBy = document.getElementById('sort-by').value;
            opportunities.sort((a, b) => {
                if (sortBy === 'volume') return b.volume24h - a.volume24h;
                if (sortBy === 'liquidity') return b.liquidity - a.liquidity;
                return b.score - a.score;
            });
        }

        function getRec(m, signals) {
            if (m.yesPrice < 0.1) return 'Long-shot YES at ' + (m.yesPrice*100).toFixed(0) + '¬¢ ‚Äî huge upside if it hits';
            if (m.yesPrice > 0.9) return 'Near-certain at ' + (m.yesPrice*100).toFixed(0) + '¬¢ ‚Äî consider NO for value';
            if (signals.includes('momentum')) return 'High activity ‚Äî ' + ((m.volume24h/m.liquidity)*100).toFixed(0) + '% volume/liquidity ratio';
            if (m.volume24h > 100000) return 'Major volume ($' + (m.volume24h/1000).toFixed(0) + 'K in 24h)';
            return 'Active market with good liquidity';
        }

        function renderOpportunities() {
            const container = document.getElementById('opportunities-list');
            document.getElementById('opp-count').textContent = opportunities.length + ' found';
            
            if (opportunities.length === 0) {
                container.innerHTML = '<div class="empty-state">No opportunities found.<br>Try lowering the liquidity filter.</div>';
                return;
            }
            
            container.innerHTML = opportunities.slice(0, 30).map(o => `
                <div class="opp-card">
                    <div class="opp-header">
                        <div class="opp-title">
                            <a href="https://polymarket.com/event/${o.slug || o.conditionId}" target="_blank">${o.question || 'Unknown'}</a>
                        </div>
                        <span class="opp-score ${o.score >= 40 ? 'score-high' : o.score >= 20 ? 'score-medium' : 'score-low'}">${o.score}</span>
                    </div>
                    <div class="opp-details">
                        <div class="detail-item">
                            <div class="detail-value" style="color:var(--accent-green)">${(o.yesPrice*100).toFixed(0)}¬¢</div>
                            <div class="detail-label">YES</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value" style="color:var(--accent-red)">${(o.noPrice*100).toFixed(0)}¬¢</div>
                            <div class="detail-label">NO</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${fmt(o.liquidity)}</div>
                            <div class="detail-label">Liquidity</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">${fmt(o.volume24h)}</div>
                            <div class="detail-label">24h Vol</div>
                        </div>
                    </div>
                    <div class="opp-meta">
                        <div>${o.signals.map(s => '<span class="tag tag-'+s+'">'+s.toUpperCase()+'</span>').join('')}</div>
                    </div>
                    <div class="recommendation">üí° ${o.recommendation}</div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('total-markets').textContent = allMarkets.length;
            document.getElementById('opportunities-found').textContent = opportunities.length;
            document.getElementById('best-score').textContent = opportunities.length > 0 ? opportunities[0].score : '-';
            const totalVol = allMarkets.reduce((s, m) => s + m.volume24h, 0);
            document.getElementById('total-volume').textContent = fmt(totalVol);
        }

        function updateChart() {
            const cats = ['politics', 'crypto', 'sports', 'other'];
            const vols = cats.map(c => allMarkets.filter(m => m.category === c).reduce((s, m) => s + m.volume24h, 0));
            
            if (volumeChart) volumeChart.destroy();
            volumeChart = new Chart(document.getElementById('volume-chart'), {
                type: 'doughnut',
                data: {
                    labels: ['Politics', 'Crypto', 'Sports', 'Other'],
                    datasets: [{
                        data: vols,
                        backgroundColor: ['rgba(88,166,255,0.8)', 'rgba(163,113,247,0.8)', 'rgba(63,185,80,0.8)', 'rgba(139,148,158,0.8)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#f0f6fc', font: { size: 11 } } }
                    }
                }
            });
        }

        function fmt(n) {
            if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
            if (n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
            return '$' + Math.round(n);
        }

        document.getElementById('min-liquidity').addEventListener('change', () => { analyzeOpportunities(); renderOpportunities(); updateStats(); });
        document.getElementById('sort-by').addEventListener('change', () => { analyzeOpportunities(); renderOpportunities(); });
    </script>
</body>
</html>
